# 本地锁

## 1、CategoryServiceImpl

```java
@Override
public Map<String, List<Catalog2VO>> getCatalogJson() {
    // 1、缓存穿透（查询结果为空）：空结果缓存
    // 2、缓存雪崩（相同过期时间）：设置过期时间（加随机值）
    // 3、缓存击穿（热点key失效）：加锁
    
    // 从缓存中查询
    final String catalogJson = stringRedisTemplate
        .opsForValue()
        .get("catalogJson");
    if (!StringUtils.isEmpty(catalogJson)) {
        log.info("缓存命中...直接返回...");
        return JSON.parseObject(catalogJson, new TypeReference<Map<String, List<Catalog2VO>>>() {});
    }

    log.info("缓存未命中...即将查询数据库...");
    // 缓存中没有在从数据库中查询
    return getCatalogJsonFromDb();
}

@Override
public Map<String, List<Catalog2VO>> getCatalogJsonFromDb() {
    synchronized (this) {
        final String catalogJson = stringRedisTemplate
            .opsForValue()
            .get("catalogJson");
        if (!StringUtils.isEmpty(catalogJson)) {
            log.info("缓存命中...直接返回...");
            return JSON.parseObject(catalogJson, new TypeReference<Map<String, List<Catalog2VO>>>() {});
        }

        log.info("缓存未命中...查询数据库...");
        // 查询所有分类，并按照父 ID 分组
        final Map<Long, List<CategoryEntity>> categoryMap = baseMapper
            .selectList(null)
            .stream()
            .collect(Collectors.groupingBy(CategoryEntity::getParentCid));
        // 查询一级分类
        final Map<String, List<Catalog2VO>> catalogJsonFromDb = categoryMap
            .get(0L)
            .stream()
            .collect(Collectors.toMap(l1 -> l1
                                      .getCatId()
                                      .toString(), l1 -> categoryMap
                                      .get(l1.getCatId())
                                      .stream()
                                      .map(l2 -> {
                                          final List<Catalog2VO.Catalog3VO> catalog3VOList = categoryMap
                                              .get(l2.getCatId())
                                              .stream()
                                              .map(l3 -> new Catalog2VO.Catalog3VO(l2
                                                                                   .getCatId()
                                                                                   .toString(), l3
                                                                                   .getCatId()
                                                                                   .toString(), l3.getName()))
                                              .collect(Collectors.toList());
                                          return new Catalog2VO(l1
                                                                .getCatId()
                                                                .toString(), catalog3VOList, l2
                                                                .getCatId()
                                                                .toString(), l2.getName());
                                      })
                                      .collect(Collectors.toList())));

        // 存入缓存
        stringRedisTemplate
            .opsForValue()
            .set("catalogJson", JSON.toJSONString(catalogJsonFromDb), 1, TimeUnit.DAYS);

        // 返回结果
        return catalogJsonFromDb;
    }
}
```

