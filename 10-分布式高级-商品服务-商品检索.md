# 商品检索

## 1、检索 DSL

```bash
GET product/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "skuTitle": "华为"
          }
        }
      ],
      "filter": [
        {
          "term": {
            "catalogId": {
              "value": "225"
            }
          }
        },
        {
          "terms": {
            "brandId": [
              "5",
              "6"
            ]
          }
        },
        {
          "nested": {
            "path": "attrs",
            "query": {
              "bool": {
                "must": [
                  {
                    "term": {
                      "attrs.attrId": {
                        "value": "16"
                      }
                    }
                  },
                  {
                    "terms": {
                      "attrs.attrValue": [
                        "8GB",
                        "12GB"
                      ]
                    }
                  }
                ]
              }
            }
          }
        },
        {
          "term": {
            "hasStock": {
              "value": "false"
            }
          }
        },
        {
          "range": {
            "skuPrice": {
              "gte": 5999,
              "lte": 7999
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "skuPrice": {
        "order": "desc"
      }
    }
  ],
  "from": 0,
  "size": 10,
  "highlight": {
    "fields": {
      "skuTitle": {}
    },
    "pre_tags": "<b style='color:red'>",
    "post_tags": "</b>"
  }
}
```



## 2、创建允许索引的索引库

```bash
PUT /gulimall_product
{
  "mappings": {
    "properties": {
      "skuId":{
        "type": "long"
      },
      "spuId":{
        "type": "keyword"
      },
      "skuTitle":{
        "type": "text",
        "analyzer": "ik_smart"
      },
      "skuPrice":{
        "type": "keyword"
      },
      "skuImg":{
        "type": "keyword"
      },
      "saleCount":{
        "type": "long"
      },
      "hasStock":{
        "type": "boolean"
      },
      "hotScore":{
        "type": "long"
      },
      "brandId":{
        "type": "long"
      },
      "catelogId":{
        "type": "long"
      },
      "brandName":{
        "type": "keyword"
      },
      "brandImg":{
        "type": "keyword"
      },
      "catelogName":{
        "type": "keyword"
      },
      "attrs":{
        "type": "nested",
        "properties": {
          "attrId":{
            "type":"long"
          },
          "attrName":{
            "type": "keyword"
          },
          "attrValue":{
            "type":"keyword"
          }
        }
      }
    }
  }
}
```

## 3、索引库数据迁移

```bash
POST _reindex
{
  "source": {
    "index": "product"
  },
  "dest": {
    "index": "gulimall_product"
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "took" : 213,
  "timed_out" : false,
  "total" : 5,
  "updated" : 0,
  "created" : 5,
  "deleted" : 0,
  "batches" : 1,
  "version_conflicts" : 0,
  "noops" : 0,
  "retries" : {
    "bulk" : 0,
    "search" : 0
  },
  "throttled_millis" : 0,
  "requests_per_second" : -1.0,
  "throttled_until_millis" : 0,
  "failures" : [ ]
}</code></pre></details>



## 4、品牌聚合（子聚合）

```bash
GET gulimall_product/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    }
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "took" : 23,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 1,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/13122bf7-68e9-4862-8ca6-178472c84eaa_%E9%9B%85%E5%B7%9D%E9%9D%92.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅川青 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 2,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/5fd11093-24ca-4d78-8865-a50013991202_%E9%9B%85%E4%B8%B9%E9%BB%91.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅丹黑 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 3,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/7dac7344-df44-400b-8501-5643ca3254d5_%E5%8D%97%E7%B3%AF%E7%B4%AB.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 南糯紫 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "4",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 4,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/494ac93f-9ed7-483a-8b40-f4338ceb9e74_%E7%99%BD%E6%B2%99%E9%93%B6.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 白沙银 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "10",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "乐臻版 雅丹黑"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 10,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/ccad1117-3261-4530-8fc5-241aee75c54e_乐臻版 雅丹黑.png",
          "skuPrice" : 7899.0,
          "skuTitle" : "华为（HUAWEI）Mate 60 Pro 乐臻版 乐臻版 雅丹黑 12GB",
          "spuId" : 10
        }
      }
    ]
  },
  "aggregations" : {
    "brand_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 5,
          "doc_count" : 5,
          "brand_img_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
                "doc_count" : 5
              }
            ]
          },
          "brand_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "华为",
                "doc_count" : 5
              }
            ]
          }
        }
      ]
    }
  }
}</code></pre></details>



## 5、分类聚合

```bash
GET gulimall_product/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    },
    "catalog_agg": {
      "terms": {
        "field": "catalogId",
        "size": 10
      },
      "aggs": {
        "catalog_name_agg": {
          "terms": {
            "field": "catalogName",
            "size": 10
          }
        }
      }
    }
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "error": {
    "root_cause": [
      {
        "type": "illegal_argument_exception",
        "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [catalogName] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."
      }
    ],
    "type": "search_phase_execution_exception",
    "reason": "all shards failed",
    "phase": "query",
    "grouped": true,
    "failed_shards": [
      {
        "shard": 0,
        "index": "gulimall_product",
        "node": "Y9qPLGnNQGuydgJrapcAog",
        "reason": {
          "type": "illegal_argument_exception",
          "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [catalogName] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."
        }
      }
    ],
    "caused_by": {
      "type": "illegal_argument_exception",
      "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [catalogName] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.",
      "caused_by": {
        "type": "illegal_argument_exception",
        "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [catalogName] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."
      }
    }
  },
  "status": 400
}</code></pre></details>

```bash
GET gulimall_product/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    },
    "catalog_agg": {
      "terms": {
        "field": "catalogId",
        "size": 10
      },
      "aggs": {
        "catalog_name_agg": {
          "terms": {
            "field": "catalogName.keyword",
            "size": 10
          }
        }
      }
    }
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 1,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/13122bf7-68e9-4862-8ca6-178472c84eaa_%E9%9B%85%E5%B7%9D%E9%9D%92.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅川青 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 2,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/5fd11093-24ca-4d78-8865-a50013991202_%E9%9B%85%E4%B8%B9%E9%BB%91.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅丹黑 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 3,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/7dac7344-df44-400b-8501-5643ca3254d5_%E5%8D%97%E7%B3%AF%E7%B4%AB.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 南糯紫 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "4",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 4,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/494ac93f-9ed7-483a-8b40-f4338ceb9e74_%E7%99%BD%E6%B2%99%E9%93%B6.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 白沙银 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "10",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "乐臻版 雅丹黑"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 10,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/ccad1117-3261-4530-8fc5-241aee75c54e_乐臻版 雅丹黑.png",
          "skuPrice" : 7899.0,
          "skuTitle" : "华为（HUAWEI）Mate 60 Pro 乐臻版 乐臻版 雅丹黑 12GB",
          "spuId" : 10
        }
      }
    ]
  },
  "aggregations" : {
    "catalog_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 225,
          "doc_count" : 5,
          "catalog_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "手机",
                "doc_count" : 5
              }
            ]
          }
        }
      ]
    },
    "brand_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 5,
          "doc_count" : 5,
          "brand_img_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
                "doc_count" : 5
              }
            ]
          },
          "brand_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "华为",
                "doc_count" : 5
              }
            ]
          }
        }
      ]
    }
  }
}
</code></pre></details>


## 6、属性聚合（nested聚合）

```bash
GET gulimall_product/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    },
    "catalog_agg": {
      "terms": {
        "field": "catalogId",
        "size": 10
      },
      "aggs": {
        "catalog_name_agg": {
          "terms": {
            "field": "catalogName.keyword",
            "size": 10
          }
        }
      }
    },
    "attr_agg": {
      "nested": {
        "path": "attrs"
      },
      "aggs": {
        "attr_id_agg": {
          "terms": {
            "field": "attrs.attrId",
            "size": 10
          },
          "aggs": {
            "attr_name_agg": {
              "terms": {
                "field": "attrs.attrName",
                "size": 10
              }
            },
            "attr_value_agg": {
              "terms": {
                "field": "attrs.attrValue",
                "size": 10
              }
            }
          }
        }
      }
    }
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "took" : 7,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 1,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/13122bf7-68e9-4862-8ca6-178472c84eaa_%E9%9B%85%E5%B7%9D%E9%9D%92.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅川青 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 2,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/5fd11093-24ca-4d78-8865-a50013991202_%E9%9B%85%E4%B8%B9%E9%BB%91.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅丹黑 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 3,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/7dac7344-df44-400b-8501-5643ca3254d5_%E5%8D%97%E7%B3%AF%E7%B4%AB.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 南糯紫 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "4",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 4,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/494ac93f-9ed7-483a-8b40-f4338ceb9e74_%E7%99%BD%E6%B2%99%E9%93%B6.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 白沙银 12GB",
          "spuId" : 4
        }
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "10",
        "_score" : 1.0,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "乐臻版 雅丹黑"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : true,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 10,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/ccad1117-3261-4530-8fc5-241aee75c54e_乐臻版 雅丹黑.png",
          "skuPrice" : 7899.0,
          "skuTitle" : "华为（HUAWEI）Mate 60 Pro 乐臻版 乐臻版 雅丹黑 12GB",
          "spuId" : 10
        }
      }
    ]
  },
  "aggregations" : {
    "catalog_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 225,
          "doc_count" : 5,
          "catalog_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "手机",
                "doc_count" : 5
              }
            ]
          }
        }
      ]
    },
    "attr_agg" : {
      "doc_count" : 55,
      "attr_id_agg" : {
        "doc_count_error_upper_bound" : 0,
        "sum_other_doc_count" : 5,
        "buckets" : [
          {
            "key" : 10,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "上市日期",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "2023-08-29",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 11,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机型",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "华为 Mate60 Pro",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 12,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身颜色",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "雅川青",
                  "doc_count" : 4
                },
                {
                  "key" : "乐臻版 雅丹黑",
                  "doc_count" : 1
                }
              ]
            }
          },
          {
            "key" : 13,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身重量",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "225g",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 14,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身尺寸",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "宽79mm；长163.65mm；厚8.1mm",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 15,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "存储卡",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "NM存储卡",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 16,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "运行内存",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "12GB",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 17,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕刷新率",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "120Hz",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 18,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕特色",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "昆仑玻璃",
                  "doc_count" : 5
                }
              ]
            }
          },
          {
            "key" : 19,
            "doc_count" : 5,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕尺寸",
                  "doc_count" : 5
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "6.82英寸",
                  "doc_count" : 5
                }
              ]
            }
          }
        ]
      }
    },
    "brand_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 5,
          "doc_count" : 5,
          "brand_img_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
                "doc_count" : 5
              }
            ]
          },
          "brand_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "华为",
                "doc_count" : 5
              }
            ]
          }
        }
      ]
    }
  }
}
</code></pre></details>


## 7、完整DSL

```bash
GET gulimall_product/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "skuTitle": "华为"
          }
        }
      ],
      "filter": [
        {
          "term": {
            "catalogId": {
              "value": "225"
            }
          }
        },
        {
          "terms": {
            "brandId": [
              "5",
              "6"
            ]
          }
        },
        {
          "nested": {
            "path": "attrs",
            "query": {
              "bool": {
                "must": [
                  {
                    "term": {
                      "attrs.attrId": {
                        "value": "16"
                      }
                    }
                  },
                  {
                    "terms": {
                      "attrs.attrValue": [
                        "8GB",
                        "12GB"
                      ]
                    }
                  }
                ]
              }
            }
          }
        },
        {
          "term": {
            "hasStock": {
              "value": "false"
            }
          }
        },
        {
          "range": {
            "skuPrice": {
              "gte": 5999,
              "lte": 7999
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "skuPrice": {
        "order": "desc"
      }
    }
  ],
  "from": 0,
  "size": 10,
  "highlight": {
    "fields": {
      "skuTitle": {}
    },
    "pre_tags": "<b style='color:red'>",
    "post_tags": "</b>"
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    },
    "catalog_agg": {
      "terms": {
        "field": "catalogId",
        "size": 10
      },
      "aggs": {
        "catalog_name_agg": {
          "terms": {
            "field": "catalogName.keyword",
            "size": 10
          }
        }
      }
    },
    "attr_agg": {
      "nested": {
        "path": "attrs"
      },
      "aggs": {
        "attr_id_agg": {
          "terms": {
            "field": "attrs.attrId",
            "size": 10
          },
          "aggs": {
            "attr_name_agg": {
              "terms": {
                "field": "attrs.attrName",
                "size": 10
              }
            },
            "attr_value_agg": {
              "terms": {
                "field": "attrs.attrValue",
                "size": 10
              }
            }
          }
        }
      }
    }
  }
}
```

<details><summary><font size="3" color="orange">返回结果</font></summary> 
<pre><code class="language-json">{
  "took" : 57,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 3,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : null,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 1,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/13122bf7-68e9-4862-8ca6-178472c84eaa_%E9%9B%85%E5%B7%9D%E9%9D%92.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅川青 12GB",
          "spuId" : 4
        },
        "highlight" : {
          "skuTitle" : [
            "<b style='color:red'>华为</b>Mate 60 Pro 雅川青 12GB"
          ]
        },
        "sort" : [
          "6999.0"
        ]
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : null,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 2,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/5fd11093-24ca-4d78-8865-a50013991202_%E9%9B%85%E4%B8%B9%E9%BB%91.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 雅丹黑 12GB",
          "spuId" : 4
        },
        "highlight" : {
          "skuTitle" : [
            "<b style='color:red'>华为</b>Mate 60 Pro 雅丹黑 12GB"
          ]
        },
        "sort" : [
          "6999.0"
        ]
      },
      {
        "_index" : "gulimall_product",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : null,
        "_source" : {
          "attrs" : [
            {
              "attrId" : 10,
              "attrName" : "上市日期",
              "attrValue" : "2023-08-29"
            },
            {
              "attrId" : 11,
              "attrName" : "机型",
              "attrValue" : "华为 Mate60 Pro"
            },
            {
              "attrId" : 12,
              "attrName" : "机身颜色",
              "attrValue" : "雅川青"
            },
            {
              "attrId" : 13,
              "attrName" : "机身重量",
              "attrValue" : "225g"
            },
            {
              "attrId" : 14,
              "attrName" : "机身尺寸",
              "attrValue" : "宽79mm；长163.65mm；厚8.1mm"
            },
            {
              "attrId" : 15,
              "attrName" : "存储卡",
              "attrValue" : "NM存储卡"
            },
            {
              "attrId" : 16,
              "attrName" : "运行内存",
              "attrValue" : "12GB"
            },
            {
              "attrId" : 17,
              "attrName" : "屏幕刷新率",
              "attrValue" : "120Hz"
            },
            {
              "attrId" : 18,
              "attrName" : "屏幕特色",
              "attrValue" : "昆仑玻璃"
            },
            {
              "attrId" : 19,
              "attrName" : "屏幕尺寸",
              "attrValue" : "6.82英寸"
            },
            {
              "attrId" : 20,
              "attrName" : "电池容量",
              "attrValue" : "5000mAh(typ)"
            }
          ],
          "brandId" : 5,
          "brandImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
          "brandName" : "华为",
          "catalogId" : 225,
          "catalogName" : "手机",
          "hasStock" : false,
          "hotScore" : 0,
          "saleCount" : 0,
          "skuId" : 3,
          "skuImg" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-02-02/7dac7344-df44-400b-8501-5643ca3254d5_%E5%8D%97%E7%B3%AF%E7%B4%AB.png",
          "skuPrice" : 6999.0,
          "skuTitle" : "华为Mate 60 Pro 南糯紫 12GB",
          "spuId" : 4
        },
        "highlight" : {
          "skuTitle" : [
            "<b style='color:red'>华为</b>Mate 60 Pro 南糯紫 12GB"
          ]
        },
        "sort" : [
          "6999.0"
        ]
      }
    ]
  },
  "aggregations" : {
    "catalog_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 225,
          "doc_count" : 3,
          "catalog_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "手机",
                "doc_count" : 3
              }
            ]
          }
        }
      ]
    },
    "attr_agg" : {
      "doc_count" : 33,
      "attr_id_agg" : {
        "doc_count_error_upper_bound" : 0,
        "sum_other_doc_count" : 3,
        "buckets" : [
          {
            "key" : 10,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "上市日期",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "2023-08-29",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 11,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机型",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "华为 Mate60 Pro",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 12,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身颜色",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "雅川青",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 13,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身重量",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "225g",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 14,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "机身尺寸",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "宽79mm；长163.65mm；厚8.1mm",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 15,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "存储卡",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "NM存储卡",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 16,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "运行内存",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "12GB",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 17,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕刷新率",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "120Hz",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 18,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕特色",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "昆仑玻璃",
                  "doc_count" : 3
                }
              ]
            }
          },
          {
            "key" : 19,
            "doc_count" : 3,
            "attr_name_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "屏幕尺寸",
                  "doc_count" : 3
                }
              ]
            },
            "attr_value_agg" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "6.82英寸",
                  "doc_count" : 3
                }
              ]
            }
          }
        ]
      }
    },
    "brand_agg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : 5,
          "doc_count" : 3,
          "brand_img_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "https://gulimall-vectorx.oss-cn-shanghai.aliyuncs.com/2024-01-31/ed106fa1-8198-46e3-8059-4864efa65dc7_huawei.png",
                "doc_count" : 3
              }
            ]
          },
          "brand_name_agg" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "华为",
                "doc_count" : 3
              }
            ]
          }
        }
      ]
    }
  }
}
</code></pre></details>
